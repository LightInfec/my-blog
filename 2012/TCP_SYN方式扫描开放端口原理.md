## TCP连接的建立原理:

 

  TCP连接首先需要一个目的IP地址和目的端口,有了这些之后,主机便可以利用它们来构造一个TCP_SYN数据包[注意:SYN是TCP数据包里面的特殊标志位(1)]来对指定主机的指定端口来进行连接请求,具体的细节是怎么样的呢?下面就跟大家介绍TCP连接的三次握手原理:

 

![图片](pic_temp8\psb1.jpg)



  从图中我们可以知道,主机A是想要和主机B进行TCP连接的,随后在这两台主机之间就有三个数据包来回.首先主机A对主机B发送TCP_SYN连接请求数据包(1st数据包),然后主机B回复TCP_SYN_ACK应答请求连接数据包(2nd数据包),最后就是主机A通告主机B一个TCP_SYN_ACK应答请求连接数据包(3rd数据包),目的是告诉主机B,我们已经建立起数据连接了.

 

## TCP端口扫描原理:

 

由TCP基本性质可以知道,要想两台主机利用TCP来进行数据传输的话就必须要先建立连接.端口扫描器就利用到这个原理,它先给指定IP指定端口发送一个SYN请求数据包,假若目标主机收到该请求数据包的话就会对另一方有所回应[在排除有防火墙和另一端主机不是在调用Accept() 函数在外] (2),于是上面的三次握手流程就变成这样.



![图片](pic_temp8\psb2.jpg)



  也许你会觉得奇怪,怎么好端端的三次握手变成了两次数据包来回呢?



  简单地来说,即便你发送了最后的TCP_SYN_ACK数据包也没有什么所谓.但是请想一下,扫描程序有那个必要再去发送么[那将会是影响扫描程序的性能原因之一]?我们只需要接收到主机B返回的 TCP_SYN_ACK就可以断定它是开放的端口.下面将为你介绍更多的关于为什么不要发送最后的TCP_SYN_ACK的理论原因以及如何判断主机是否存活和未使用的TCP端口检测.

 

## 对黑客和服务器致命的TCP_SYN_ACK:

 

![图片](pic_temp8\psb3.jpg)



#### 对服务器:

 

  有过TCP/IP编程经验的朋友们都知道:Accpet()函数是用来接收来自Connect()函数发出的TCP连接,当Accpet()函数被调用的时候,它是以阻塞的方式来接收来自Connect()的连接.Accept()会判断是否有TCP_SYN请求数据包的到来(3),有的话Accept()将回复TCP_SYN_ACK并等待接收对方的TCP_SYN_ACK,反之则Accept()函数返回,我们先做这样的假设:在一个并发服务器中,服务主线程通过Accept()来接受连接再创建客户服务子线程.



  请你想一想,假设数据包以图二的情况来进行TCP请求的话,服务器主线程会怎么样呢?



  毫无疑问,服务主线程将会阻塞,即使其它想要连接到这台服务器的主机也需要”排队”(4)等待服务主线程的TCP_SYN_ACK应答,这样不单止会另服务器运行变慢,也会使它消耗对一些内存.TCP_SYN攻击就是利用这个原理,被攻击者轻则主机运行,网速变慢,重则系统崩溃.

 

#### 对黑客:

 

  TCP/IP实现的许多细节已经不能被我们所查觉到,当然,TCP/IP也会有记录,请你联想一下getpeersock()函数就是一个很好的例子,为什么最后的TCP_SYN_ACK对黑客来说的致命的呢?原因是当TCP/IP对于连接成功的端口会产生记录,这个记录包含了黑客的IP地址,假设黑客要对某一系统进行入侵的话,这将会是不可诋毁的证据.但TCP/IP是不会对连接不成功的端口进行记录的,这样也就大大保证了SYN扫描的隐蔽性.

 

## ICMP网络不可到达和TCP_RST

 

  假如对网络上一台不存在的主机进行TCP连接请求的话会怎样呢?让Ping程序告诉你应该知道的ICMP网络不可到达:

 

  正常情况下,Ping程序返回的结果:

 

![图片](pic_temp8\psb4.jpg)

 

  随便输入一个IP进行测试

 

![图片](pic_temp8\psb5.jpg)



  图中的Requst timed out指的是ICMP请求超时,超时的因素有很多,而在这儿就是想告诉读者们,Ping程序接收到了ICMP网络不可到达数据包,然后给我们输出ICMP请求超时.



  同样的,我们对一个无效的IP地址进行TCP_SYN请求后经过一段时间后就会收到ICMP网络不可到达的数据包,扫描根据它可以判断目标主机是否存活.

 

  有些时候,我们对主机进行TCP_SYN请求时会收到TCP_RST数据包,原因有几个: 目的端口未使用,目的端口已连接(5),目的端口正在关闭,目的端口已经重新启动等.



## 对文段中的一些注解:

 

1. 下面是IP数据包头和TCP数据包头的结构:



![图片](pic_temp8\psb6.gif)



  在倒数第四行里有六个标志位,每一位标志都具有不同的意义,讨论它们将超出本文的范畴,本文一共介绍TCP数据包的三种结构:SYN,ACK,RST.每个标志占数据包一比特.

 

2. 由于现代的大多数防火墙都有过滤功能,所以TCP_SYN请求在理想状态下才能保证像上面一样的传输流程,至于Accept()函数和TCP三次握手的关系请参见图三.

 

3. 谁也不能保证在调用Accept()的时候[用阻塞的办法调用Accept()除外]就刚刚好接收到来自远程主机的TCP_SYN请求数据包,那为什么Accept()没有同步接收到数据包就可以接收到TCP_SYN数据包呢?原因是TCP/IP协议预先已经给每个Socket都分配一定大小的接收缓冲,Accept()只是检查Socket接收缓冲里面是否有TCP_SYN数据包来判断是否有远程主机进行连接而已.

 

4. 原理和上面一样,TCP_SYN不断地再缓冲中增加,当TCP_SYN数量超出一定的时候将会被系统丢弃,原因是缓冲太小不能容纳太多的TCP_SYN请求.

 

5. 有一些TCP/IP 版本会这样处理

 